<template>
  <div v-if="visible" class="preview-mask">
    <div class="preview-content">
      <span class="close" @click="visible = false"><svg t="1621927142745" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1179" width="38" height="38"><path d="M885.314 835.089l-329.395-329.396 329.395-329.396c12.128-12.128 12.128-31.792 0-43.919-12.127-12.128-31.792-12.128-43.919 0l-329.396 329.396-329.396-329.396c-12.128-12.128-31.792-12.128-43.919 0s-12.128 31.792 0 43.919l329.395 329.396-329.395 329.396c-12.128 12.128-12.128 31.793 0 43.919 12.128 12.128 31.792 12.128 43.919 0l329.396-329.396 329.396 329.396c12.128 12.128 31.793 12.128 43.919 0 12.128-12.127 12.128-31.792 0-43.919z" fill="#ffffff" p-id="1180"></path></svg></span>
      <div class="img-wrapper">
        <div class="img-box" ref="imgBox">
          <div v-if="!list.length" class="empty">没有可预览的图片</div>
          <div class="img-list">
            <div v-for="img in list" :key="img" class="img-item" :style="{width: clientWidth}">
              <img :src="img" :alt="img" ref="img">
            </div>
          </div>
        </div>
      </div>
      <div v-if="list.length" class="img-tools">
        <span class="action" title="上一张" @click="changeImg(-1)">
            <svg t="1621927510660" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5163" width="28" height="28"><path d="M754.285714 176.342857V88c0-7.657143-8.8-11.885714-14.742857-7.2L224.342857 483.2a36.411429 36.411429 0 0 0 0 57.485714l515.2 402.4c6.057143 4.685714 14.742857 0.457143 14.742857-7.2v-88.342857c0-5.6-2.628571-10.971429-6.971428-14.4l-411.428572-321.142857 411.428572-321.257143c4.342857-3.428571 6.971429-8.8 6.971428-14.4z" p-id="5164" fill="#ffffff"></path></svg>
        </span>
        <span class="action" title="下一张" @click="changeImg(1)">
            <svg t="1621927780022" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5462" width="28" height="28"><path d="M801.942857 483.2L286.742857 80.8A9.108571 9.108571 0 0 0 272 88v88.342857c0 5.6 2.628571 10.971429 6.971429 14.4l411.428571 321.257143-411.428571 321.257143c-4.457143 3.428571-6.971429 8.8-6.971429 14.4V936c0 7.657143 8.8 11.885714 14.742857 7.2l515.2-402.4a36.525714 36.525714 0 0 0 0-57.6z" p-id="5463" fill="#ffffff"></path></svg>
        </span>
        <span class="action" title="放大" @click="zoomImg(1)">
            <svg t="1621927810301" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5681" width="28" height="28"><path d="M258.285714 197.028571l50.171429-50.171428a9.154286 9.154286 0 0 0-5.371429-15.542857L120 109.714286c-5.828571-0.685714-10.857143 4.228571-10.171429 10.171428L131.428571 302.971429c0.914286 7.542857 10.171429 10.742857 15.542858 5.371428l49.942857-49.942857L349.714286 411.085714c3.542857 3.542857 9.371429 3.542857 12.914285 0l48.457143-48.342857c3.542857-3.542857 3.542857-9.371429 0-12.914286L258.285714 197.028571z m403.085715 214.057143c3.542857 3.542857 9.371429 3.542857 12.914285 0l152.8-152.685714 49.942857 49.942857a9.154286 9.154286 0 0 0 15.542858-5.371428L914.171429 120c0.685714-5.828571-4.228571-10.857143-10.171429-10.171429L720.914286 131.428571c-7.542857 0.914286-10.742857 10.171429-5.371429 15.542858l50.171429 50.171428L612.914286 349.714286a9.177143 9.177143 0 0 0 0 12.914285l48.457143 48.457143zM892.571429 721.028571c-0.914286-7.542857-10.171429-10.742857-15.542858-5.371428l-49.942857 49.942857L674.285714 612.914286a9.177143 9.177143 0 0 0-12.914285 0l-48.457143 48.342857a9.177143 9.177143 0 0 0 0 12.914286L765.714286 826.971429l-50.171429 50.171428a9.154286 9.154286 0 0 0 5.371429 15.542857L904 914.285714c5.828571 0.685714 10.857143-4.228571 10.171429-10.171428L892.571429 721.028571z m-529.942858-108.114285a9.177143 9.177143 0 0 0-12.914285 0L196.914286 765.6l-49.942857-49.942857a9.154286 9.154286 0 0 0-15.542858 5.371428L109.828571 904c-0.685714 5.828571 4.228571 10.857143 10.171429 10.171429L303.085714 892.571429c7.542857-0.914286 10.742857-10.171429 5.371429-15.542858L258.285714 826.971429 411.085714 674.285714c3.542857-3.542857 3.542857-9.371429 0-12.914285l-48.457143-48.457143z" p-id="5682" fill="#ffffff"></path></svg>
        </span>
        <span class="action" title="缩小" @click="zoomImg(-1)">
            <svg t="1621927830973" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5900" width="28" height="28"><path d="M373.714286 202.171429c-0.914286-7.542857-10.171429-10.742857-15.542857-5.371429l-49.942858 49.942857L155.428571 94.057143a9.177143 9.177143 0 0 0-12.914285 0l-48.457143 48.342857a9.177143 9.177143 0 0 0 0 12.914286L246.857143 308.114286l-50.171429 50.171428a9.154286 9.154286 0 0 0 5.371429 15.542857L385.142857 395.428571c5.828571 0.685714 10.857143-4.228571 10.171429-10.171428L373.714286 202.171429z m11.542857 426.514285L202.057143 650.285714c-7.542857 0.914286-10.742857 10.171429-5.371429 15.542857l50.171429 50.171429L94.057143 868.571429a9.177143 9.177143 0 0 0 0 12.914285l48.457143 48.342857c3.542857 3.542857 9.371429 3.542857 12.914285 0L308.228571 777.142857l49.942858 49.942857A9.154286 9.154286 0 0 0 373.714286 821.714286l21.6-182.971429c0.685714-5.828571-4.228571-10.742857-10.057143-10.057143z m253.485714-233.371428L821.942857 373.714286c7.542857-0.914286 10.742857-10.171429 5.371429-15.542857L777.142857 308.114286 929.942857 155.428571c3.542857-3.542857 3.542857-9.371429 0-12.914285l-48.457143-48.342857a9.177143 9.177143 0 0 0-12.914285 0L715.771429 246.742857l-49.942858-49.942857a9.154286 9.154286 0 0 0-15.542857 5.371429L628.685714 385.142857c-0.685714 5.942857 4.228571 10.857143 10.057143 10.171429zM777.142857 715.885714l50.171429-50.171428a9.154286 9.154286 0 0 0-5.371429-15.542857L638.857143 628.571429c-5.828571-0.685714-10.857143 4.228571-10.171429 10.171428L650.285714 821.828571c0.914286 7.542857 10.171429 10.742857 15.542857 5.371429l49.942858-49.942857L868.571429 929.942857c3.542857 3.542857 9.371429 3.542857 12.914285 0l48.457143-48.342857c3.542857-3.542857 3.542857-9.371429 0-12.914286L777.142857 715.885714z" p-id="5901" fill="#ffffff"></path></svg>
        </span>
        <span class="action" title="向右翻转90°" @click="rotateImg(1)">
            <svg t="1621927951787" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6338" width="28" height="28"><path d="M511.314286 68.571429C258.857143 68.914286 54.857143 273.142857 54.857143 525.6c0 146.285714 68.8 276.571429 175.771428 360.228571l-42.857142 54.857143c-4.685714 6.057143-0.342857 14.857143 7.2 14.742857l190.857142-0.914285c5.942857 0 10.285714-5.6 8.8-11.314286L349.485714 757.714286a9.142857 9.142857 0 0 0-16.114285-3.428572L286.857143 813.828571c-11.657143-9.142857-22.857143-19.085714-33.485714-29.714285a364.16 364.16 0 0 1-78.4-116.228572C155.885714 622.857143 146.285714 574.971429 146.285714 525.6s9.6-97.257143 28.685715-142.285714c18.4-43.542857 44.8-82.628571 78.4-116.228572 33.6-33.6 72.685714-60 116.228571-78.4C414.742857 169.6 462.628571 160 512 160s97.257143 9.6 142.285714 28.685714c43.542857 18.4 82.628571 44.8 116.228572 78.4 33.6 33.6 60 72.685714 78.4 116.228572 19.085714 45.028571 28.685714 92.914286 28.685714 142.285714s-9.6 97.257143-28.685714 142.285714a364.16 364.16 0 0 1-78.4 116.228572c-8.571429 8.571429-17.485714 16.571429-26.742857 24.228571a9.062857 9.062857 0 0 0-1.371429 12.685714l45.028571 57.714286c3.2 4 9.028571 4.685714 13.028572 1.485714C903.428571 796.342857 969.142857 668.685714 969.142857 525.6c0-252.685714-205.028571-457.371429-457.828571-457.028571z" p-id="6339" fill="#ffffff"></path></svg>
        </span>
        <span class="action" title="向左翻转90°" @click="rotateImg(-1)">
            <svg t="1621928328676" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6995" width="28" height="28"><path d="M793.371429 885.828571C900.342857 802.171429 969.142857 671.885714 969.142857 525.6 969.142857 273.142857 765.142857 68.914286 512.685714 68.571429 259.885714 68.228571 54.857143 272.914286 54.857143 525.6c0 143.085714 65.714286 270.742857 168.685714 354.514286 4 3.2 9.828571 2.514286 13.028572-1.485715l45.028571-57.714285c3.085714-3.885714 2.4-9.485714-1.371429-12.685715-9.257143-7.542857-18.171429-15.657143-26.742857-24.228571a364.16 364.16 0 0 1-78.4-116.228571C155.885714 622.857143 146.285714 574.971429 146.285714 525.6s9.6-97.257143 28.685715-142.285714c18.4-43.542857 44.8-82.628571 78.4-116.228572 33.6-33.6 72.685714-60 116.228571-78.4C414.742857 169.6 462.628571 160 512 160s97.257143 9.6 142.285714 28.685714c43.542857 18.4 82.628571 44.8 116.228572 78.4 33.6 33.6 60 72.685714 78.4 116.228572 19.085714 45.028571 28.685714 92.914286 28.685714 142.285714s-9.6 97.257143-28.685714 142.285714a364.16 364.16 0 0 1-78.4 116.228572c-10.628571 10.628571-21.828571 20.571429-33.485715 29.714285L690.514286 754.285714a9.142857 9.142857 0 0 0-16.114286 3.428572l-45.257143 185.371428c-1.371429 5.714286 2.971429 11.314286 8.8 11.314286l190.857143 0.914286c7.657143 0 12-8.8 7.2-14.742857l-42.628571-54.742858z" p-id="6996" fill="#ffffff"></path></svg>        </span>
        <span class="action" title="还原" @click="reset">
            <svg t="1621928058012" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6776" width="28" height="28"><path d="M132.571429 128h-68.571429c-5.028571 0-9.142857 4.114286-9.142857 9.142857v749.714286c0 5.028571 4.114286 9.142857 9.142857 9.142857h68.571429c5.028571 0 9.142857-4.114286 9.142857-9.142857V137.142857c0-5.028571-4.114286-9.142857-9.142857-9.142857z m827.428571 0h-68.571429c-5.028571 0-9.142857 4.114286-9.142857 9.142857v749.714286c0 5.028571 4.114286 9.142857 9.142857 9.142857h68.571429c5.028571 0 9.142857-4.114286 9.142857-9.142857V137.142857c0-5.028571-4.114286-9.142857-9.142857-9.142857zM824.342857 503.2L678.514286 388.114286a8.262857 8.262857 0 0 0-13.371429 6.514285V470.857143H358.857143v-71.771429c0-6.857143-8-10.742857-13.371429-6.514285L199.657143 507.771429a8.16 8.16 0 0 0 0 12.914285l145.714286 115.2c5.371429 4.228571 13.371429 0.457143 13.371428-6.514285V553.142857h306.285714v71.771429c0 6.857143 8 10.742857 13.371429 6.514285l145.714286-115.2c4.342857-3.314286 4.342857-9.714286 0.228571-13.028571z" p-id="6777" fill="#ffffff"></path></svg>
        </span>
        <span class="action" title="下载" @click="downloadImg">
            <svg t="1621928000209" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6557" width="28" height="28"><path d="M909.6 818.285714H114.4c-5.142857 0-9.257143 4.114286-9.257143 9.142857v68.571429c0 5.028571 4.114286 9.142857 9.257143 9.142857h795.2c5.142857 0 9.257143-4.114286 9.257143-9.142857v-68.571429c0-5.028571-4.114286-9.142857-9.257143-9.142857zM504.8 691.428571a9.142857 9.142857 0 0 0 14.4 0l128-161.942857c4.685714-5.942857 0.457143-14.742857-7.2-14.742857h-84.685714V128c0-5.028571-4.114286-9.142857-9.142857-9.142857h-68.571429c-5.028571 0-9.142857 4.114286-9.142857 9.142857v386.628571H384c-7.657143 0-11.885714 8.8-7.2 14.742858l128 162.057142z" p-id="6558" fill="#ffffff"></path></svg>
        </span>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'ImgPreview',
  data () {
    return {
      visible: false,
      clientWidth: 0, // 图片容器宽度
      list: [], // 图片列表
      scale: 1, // 图片初始缩放比例
      rotate: 0, // 图片初始旋转比例
      translateX: 0, // 图片盒子初始水平平移距离
      active: 0 // 当前活动的图片
    }
  },
  mounted () {
    this.clientWidth = document.body.offsetWidth + 'px'
    document.body.addEventListener('mousewheel', this.mousewheelZoom)
  },
  beforeDestroy () {
    document.body.removeEventListener('mousewheel', this.mousewheelZoom)
  },
  methods: {
    show () {
      this.visible = true
    },
    // 切换图片
    changeImg (dir) {
      if (dir > 0 && this.active === this.list.length - 1) {
        return
      }
      if (dir < 0 && this.active === 0) {
        return
      }
      if (dir > 0 && this.active < this.list.length - 1) {
        this.active += 1
      } else if (dir < 0 && this.active > 0) {
        this.active -= 1
      }
      this.scale = 1
      this.translateX = -100 * this.active
      this.setImgTransform()
      this.$refs.imgBox.style.transform = 'translateX(' + this.translateX + '%)'
    },
    // 鼠标滚轮缩放图片
    mousewheelZoom (arg) {
      const dir = (arg.detail || -arg.wheelDelta) > 0 ? -1 : 1
      this.zoomImg(dir)
    },
    // zoom图片
    zoomImg (dir) {
      this.scale = dir > 0 ? this.scale + 0.2 : dir < 0 ? this.scale - 0.2 : 1
      if (this.scale < 0.4) {
        this.scale = 0.4
        return
      } else if (this.scale > 3.2) {
        this.scale = 3.2
        return
      }
      this.setImgTransform()
    },
    // 翻转图片
    rotateImg (dir) {
      this.rotate = dir > 0 ? this.rotate - 90 : this.rotate + 90
      this.setImgTransform()
    },
    // 还原图片
    reset () {
      this.scale = 1
      this.rotate = 0
      this.setImgTransform()
    },
    // 设置图片的transform
    setImgTransform () {
      this.$refs.img[this.active].style.transform = 'rotateZ(' + this.rotate + 'deg) scale(' + this.scale + ')'
    },
    // 下载图片(利用canvas处理跨域图片直接打开图片的问题)
    downloadImg () {
        try {
            let image = new Image()
            image.crossOrigin = 'anonymous';
            image.onload = () => {
                let canvas = document.createElement('canvas')
                canvas.width = image.width
                canvas.height = image.height
                let context = canvas.getContext('2d')
                context.drawImage(image, 0, 0, image.width, image.height)
                let url = canvas.toDataURL('image/png')
                let a = document.createElement('a')
                let event = new MouseEvent('click')
                a.download = '';
                a.href = url
                a.dispatchEvent(event)
            }
            image.onerror = (err) => {
                console.log('图片下载失败')
            }
            image.src = this.list[this.active]
        } catch (err) {
            console.log('图片下载失败')
        }
    },
  }
}
</script>

<style lang="less">
.preview-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  background: rgba(0, 0, 0, 0.6);
  .preview-content {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-content: center;
    align-items: center;
  }
  .close{
      position: fixed;
      top: 20px;
      right: 20px;
      cursor: pointer;
      z-index: 10000;
  }
  .img-wrapper {
    width: 100%;
    height: calc(100% - 50px);
    overflow: hidden;
    .img-box {
      width: 100%;
      height: 100%;
      transition: all 0.5s;
    }
    .empty{
        font-size: 22px;
        color: #fff
    }
    .img-list {
      width: 10000%;
      height: 100%;
      display: flex;
    }
    .img-item {
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
      width: 100%;
      height: 100%;
      text-align: center;
      position: relative;
      overflow: hidden;
      img {
        max-width: 100%;
        max-height: 100%;
        transform-origin: center;
        transition: all 0.5s;
      }
    }
  }
  .img-tools {
    text-align: center;
    color: #fff;
    .action {
      display: inline-block;
      margin: 10px;
      cursor: pointer;
    }
  }
}
</style>
 